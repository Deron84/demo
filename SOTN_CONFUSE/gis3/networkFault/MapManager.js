define(["esri/map","esri/layers/WebTiledLayer","utils/GeometryUtil","esri/layers/GraphicsLayer","esri/graphic","utils/SymbolUtil","dojo/_base/declare"],function(c,e,f,g,d,a,b){return b(null,{map:null,constructor:function(){var l=new c("map",Global.mapGlobal.mapInstance.mapOptions);this.map=l;Global.mapGlobal.map=l;if(Global.mapGlobal.mapInstance.isCenter){l.centerAndZoom(f.getPoint(Global.mapGlobal.mapInstance.center[0],Global.mapGlobal.mapInstance.center[1],""),Global.mapGlobal.mapInstance.zoom)}var i=new e(Global.mapGlobal.base.map,{copyright:"Heditu",id:"baseMap"});l.addLayer(i);var m=new g();l.addLayer(m);Global.mapGlobal.lineLayer=m;var k=new g();l.addLayer(k);Global.mapGlobal.otnLayer=k;var j=new g();l.addLayer(j);Global.mapGlobal.textLayer=j;var h=this;h.drawingGraphics(h);h.realQueryWarningOTN(h);Global.mapGlobal.otnLayer.on("click",function(o){if(Global.mapGlobal.clickGraphic.gra&&Global.mapGlobal.clickGraphic.sym){Global.mapGlobal.clickGraphic.gra.setSymbol(Global.mapGlobal.clickGraphic.sym)}Global.mapGlobal.clickGraphic.gra=o.graphic;Global.mapGlobal.clickGraphic.sym=o.graphic.symbol;if(o.graphic.attributes.aggr){var n=$("<div/>").menu({});o.graphic.attributes.aggr.map(function(p,q){console.error("点击资源",o.graphic.attributes);n.menu("appendItem",{text:p.oname,data:p,onclick:function(){Global.mapGlobal.textLayer.clear();o.graphic.setSymbol(a.getOTNHightSymbol());var r=new d(o.graphic.geometry,a.getTextSymbol(o.graphic.attributes.oname));Global.mapGlobal.textLayer.add(r)}})})}n.menu("show",{left:o.pageX,top:o.pageY})});Global.mapGlobal.map.on("click",function(){Global.mapGlobal.textLayer.clear();if(Global.mapGlobal.clickGraphic.gra&&Global.mapGlobal.clickGraphic.sym){Global.mapGlobal.clickGraphic.gra.setSymbol(Global.mapGlobal.clickGraphic.sym)}})},drawingGraphics:function(h){$.get(Global.mapGlobal.queryPOI.queryOTN,function(i){if(i&&i.nodes){Global.mapGlobal.lineLayer.clear();Global.mapGlobal.otnLayer.clear();if(i.edges){h._drawingLines(i.edges)}h._drawingPoints(i.nodes);h.queryWarningOTN(h)}})},realQueryWarningOTN:function(h){if(Global.mapGlobal.queryPOI.realQueryFlag){setInterval(function(){h.queryWarningOTN(h)},Global.mapGlobal.queryPOI.realQueryTimer)}},_drawingLines:function(h){h.map(function(n,j){var m=f.getPoint(n.a_longitude,n.a_lantitude,"");var l=f.getPoint(n.z_longitude,n.z_lantitude,"");var i=f.getPolylineByPoints(m,l);var k=new d(i,a.getLineSymbol(),n);Global.mapGlobal.lineLayer.add(k)})},_drawingPoints:function(h){h.map(function(k,i){var l=f.getPoint(k.longitude,k.lantitude,"");var j=new d(l,a.getOTNSymbol(),k);Global.mapGlobal.otnLayer.add(j)})},queryWarningOTN:function(h){$.get(Global.mapGlobal.queryPOI.queryWarningOTN,function(i){if(i&&i.site){h._handlerOTNWarning(i.site)}if(i&&i.topolink){h._handlerLineWarning(i.topolink)}})},_handlerOTNWarning:function(h){h.map(function(j,i){Global.mapGlobal.otnLayer.graphics.map(function(l,k){if(l.attributes.oid==j){l.setSymbol(a.getOTNWarningSymbol())}})})},_handlerLineWarning:function(h){h.map(function(j,i){Global.mapGlobal.lineLayer.graphics.map(function(m,l){var k=false;m.attributes.aggr.map(function(n,o){if(n.oid==j){k=true}});if(k){m.setSymbol(a.getWarningLineSymbol())}})})}})});